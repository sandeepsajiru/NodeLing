<!doctype html>
<html lang="en" ng-app="app" ng-controller="ctrl">
<head>
	<meta charset="UTF-8">
	<title>Compiler - Sonny Lab</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<script src="/scripts/jquery.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>
<body>
    <div>
        <h3><%= title %></h3>
        <p class="text-primary"><%= description %></p>
    </div>
    
    <div>
    <form method="post" id="myCode">
			<div class="col-2-3">
					<textarea name="script" id="textarea" cols="80" rows="15"><%= userCode %></textarea>
                    <textarea name="probId" style="display:none"><%= id %></textarea>
					<button class="btn" type="submit">Save and Compile!</button>				
			</div>
			<div class="col-1-3">
				<div class="loading" style="display:none"></div>				
				<h3>Result</h3>
				<div name="result" id="result" cols="80" rows="4" disabled="disabled"></div>
    </form>
    </div>
    <ul>
        <li ng-repeat="x in results">
    {{ x.result }}
  </li>
    </ul>
    
    
<script>
    var app=angular.module('app', []);
    app.controller('ctrl',function($scope, $http) {
        //$http.post("/compile")
             //.success(function (response) {$scope.results = response.results;});
    });
    
	function inject(callback) {
	    var baseUrl = "/src/";
	    
	    var load = window.__ace_loader__ = function(path, module, callback) {
	        var head = document.getElementsByTagName('head')[0];
	        var s = document.createElement('script');
	    
	        s.src = baseUrl + path;
	        head.appendChild(s);
	        
	        s.onload = function() {
	            window.__ace_shadowed__.require([module], callback);
	        };
	    };

	    load('ace-compiler.js', "ace/ext/textarea", function() {
	        var ace = window.__ace_shadowed__;
	        
	        ace.options.mode = "c_cpp";
	        var Event = ace.require("ace/lib/event");
	        var areas = document.getElementsByTagName("textarea");
	        for (var i = 0; i < areas.length; i++) {
	            Event.addListener(areas[i], "click", function(e) {
	                if (e.detail == 3) {
	                    ace.transformTextarea(e.target, load);
	                }
	            });
	        }
	        callback && callback();
	    });
	}

	// Call the inject function to load the ace files.
	var textAce;
	$(document).ready(function() {
		inject(function () {
		    // Transform the textarea on the page into an ace editor.
		    var ace = window.__ace_shadowed__;
		    var t = document.querySelector("textarea");
		    textAce = ace.transformTextarea(t, window.__ace_loader__);
		    setTimeout(function(){textAce.setDisplaySettings(false)});
		    // console.log(textAce);
		});

	   $('#myCode').submit(function (event) {
			event.preventDefault();
			$('.loading').slideDown('slow');
			$('#result').html('');
			$('#textarea').val(textAce.getSession().getValue());
			localStorage.mycode = textAce.getSession().getValue();
			var datastring = $("#myCode").serialize();
			$.ajax({
			    type: "POST",
			    url: "/compile",
			    timeout: 20000,
			    data: datastring,
			    dataType: "json",
			    success: function(data) {
                    
			        if (!data.compileSuccess) {
			        	$('#result').html("<b>Compilation FAILED</b><br>"+data.error.replace(new RegExp('\r?\n','g'), '<br />'));
			        } else {
                        var r='';
                        data.testCaseResults.forEach(                            
                            function(val){
                                r+=val.testCase.desc+'  '+val.result + '<br />';
                            }
                        );
			        	$('#result').html(r);
			        }
			        $('.loading').slideUp('slow');
			    },
			    error: function(error){
			        console.log(error);
			        $('.result').html(error);
			        $('.loading').slideUp('slow');
			    }
			});
			// return false;
		});
	});

</script>
    
</body>
</html>